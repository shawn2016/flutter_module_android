<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Location Selection</title>
    <script type="text/javascript" src="https://js.cdn.aliyun.dcloud.net.cn/dev/uni-app/uni.webview.1.5.2.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* --safe-area-top: env(safe-area-inset-top, 0px); */
            --safe-area-top: 0px;
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding-top: var(--safe-area-top);
            padding-left: var(--safe-area-left);
            padding-right: var(--safe-area-right);
            padding-bottom: var(--safe-area-bottom);
        }

        #googleMap {
            width: 100%;
            height: 65vh;
            position: relative;
            background: #f5f5f5;
        }

        .search-box {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35vh;
            z-index: 1000;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 20px;
            display: flex;
            flex-direction: column;
            /* ç§»é™¤è¿‡æ¸¡æ•ˆæœï¼Œä¿æŒå›ºå®šé«˜åº¦ */
        }

        /* ç§»é™¤åŠ¨æ€é«˜åº¦è°ƒæ•´ï¼Œä¿æŒå›ºå®šé«˜åº¦ */

        .search-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
            margin-bottom: 10px;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .cancel-button {
            background: none;
            border: none;
            color: #007AFF;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            display: none;
            white-space: nowrap;
            height: 40px;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-bottom: 10px;
        }

        .cancel-button:hover {
            background-color: #f0f0f0;
        }

        .search-results {
            position: relative;
            background: white;
            max-height: 50vh;
            overflow-y: auto;
            z-index: 1001;
            display: none;
            flex: 1;
            padding-bottom: 0;
        }

        .search-result-item {
            padding: 10px 0;
            margin: 0;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s ease;
            line-height: 1.4;
            display: flex;
            /* æ·»åŠ  flex å¸ƒå±€ */
            align-items: center;
            /* å‚ç›´å±…ä¸­å¯¹é½ */
            gap: 10px;
            /* ä¸¤ä¸ªdivä¹‹é—´çš„é—´è· */
        }

        .search-result-item .content {
            flex: 1;
            /* ç¬¬ä¸€ä¸ªdivå æ®å‰©ä½™ç©ºé—´ */
        }

        .search-result-item .checkbox {
            /* ç¬¬äºŒä¸ªdivåªå ç”¨éœ€è¦çš„ç©ºé—´ */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #28a745;
            font-size: 20px;
            font-weight: bold;
            flex-shrink: 0;
            /* é˜²æ­¢æ”¶ç¼© */
            min-width: 24px;
            /* ç»™å¯¹å‹¾é¢„ç•™å›ºå®šå®½åº¦ */
        }

        /* æœªé€‰ä¸­çŠ¶æ€ï¼šcontenté“ºæ»¡æ•´ä¸ªå®½åº¦ */
        .search-result-item:not(.selected) .content {
            flex: 1;
            width: 100%;
        }

        /* æœªé€‰ä¸­çŠ¶æ€ï¼šéšè—checkbox */
        .search-result-item:not(.selected) .checkbox {
            display: none;
        }

        /* é€‰ä¸­çŠ¶æ€ï¼šæ˜¾ç¤ºcheckboxï¼Œcontentå æ®å‰©ä½™ç©ºé—´ */
        .search-result-item.selected .content {
            flex: 1;
        }

        .search-result-item.selected .checkbox {
            display: flex;
        }

        /* ç§»é™¤é€‰ä¸­çŠ¶æ€çš„èƒŒæ™¯é¢œè‰² */
        .search-result-item.selected {
            background-color: transparent;
        }

        .search-result-item:hover {
            background: transparent;
        }

        .search-result-item:active {
            background: transparent !important;
        }

        /* ç¡®ä¿ç‚¹å‡»æ—¶å®Œå…¨æ²¡æœ‰èƒŒæ™¯æ•ˆæœ */
        .search-result-item:focus,
        .search-result-item:focus-visible {
            background: transparent !important;
            outline: none;
        }

        /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº®å’Œç”¨æˆ·é€‰æ‹© */
        .search-result-item {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .search-result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .search-result-item .location-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .search-result-item .location-address {
            font-size: 13px;
            color: #666;
            line-height: 1.3;
        }

        /* é€‰ä¸­çŠ¶æ€æ ·å¼ */
        .selected-mark {
            display: none;
            /* éšè—åŸæ¥çš„é€‰ä¸­æ ‡è®° */
        }



        .top-buttons {
            position: fixed;
            top: calc(60px + env(safe-area-inset-top));
            left: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            position: fixed;
            top: calc(60px + env(safe-area-inset-top));
            left: 20px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .close-btn svg {
            width: 28px;
            height: 28px;
        }

        .close-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .close-btn:active {
            background: rgba(0, 0, 0, 1);
        }

        .map-controls {
            position: fixed;
            bottom: calc(35vh + 20px);
            right: 20px;
            z-index: 1000;
            /* ç§»é™¤è¿‡æ¸¡æ•ˆæœï¼Œä¿æŒå›ºå®šä½ç½® */
        }

        /* ä¿æŒæˆ‘çš„ä½ç½®æŒ‰é’®å›ºå®šä½ç½® */

        .my-location-btn {
            background: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .confirm-button {
            position: fixed;
            top: calc(60px + env(safe-area-inset-top));
            right: 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .confirm-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }



        @media screen and (max-width: 768px) {

            html,
            body {
                font-size: 14px;
            }

            .search-box {
                padding: 15px;
            }

            .search-input {
                padding: 10px 14px;
                font-size: 14px;
                height: 36px;
                display: flex;
                align-items: center;
            }

            .search-container {
                gap: 4px;
            }

            .cancel-button {
                padding: 6px 10px;
                font-size: 13px;
                height: 36px;
                margin-bottom: 10px;
            }

            .top-buttons {
                left: 15px;
                right: 15px;
            }

            .close-btn {
                top: 60px;
                width: 35px;
                height: 35px;
            }

            .close-btn svg {
                width: 26px;
                height: 26px;
            }

            .confirm-button {
                top: 60px;
                padding: 8px 20px;
                font-size: 14px;
            }

            .map-controls {
                bottom: calc(35vh + 15px);
                right: 15px;
            }
        }

        .gm-style-mtc {
            display: none !important;
        }

        .gm-style-moc {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="googleMap"></div>

    <div class="top-buttons">
        <button class="close-btn" onclick="closeMap()" title="Close Map">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
        </button>
        <button class="confirm-button" id="confirmButton" onclick="confirmLocation()" disabled>Done</button>
    </div>

    <div class="search-box">
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search location"
                oninput="searchAddress()" onfocus="handleSearchFocus()" onblur="handleSearchBlur()">
            <button class="cancel-button" id="cancelButton" onclick="cancelSearch()">Cancel</button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <div class="map-controls">
        <button class="my-location-btn" onclick="getMyLocation()" title="My Location">ğŸ“</button>
    </div>

    <script>
        let mapKey = '';
        let map = null;
        let marker = null;

        let geocoder = null;
        let selectedLocation = null;
        let searchTimeout = null;
        let searchCache = new Map();

        function GetUrlParam(paraName) {
            const url = window.location.href;
            const arrObj = url.split("?");

            if (arrObj.length > 1) {
                const arrPara = arrObj[1].split("&");
                for (let i = 0; i < arrPara.length; i++) {
                    const arr = arrPara[i].split("=");
                    if (arr != null && arr[0] == paraName) {
                        return decodeURIComponent(arr[1] || '');
                    }
                }
            }
            return "";
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            return Math.round(distance);
        }

        // æ ¼å¼åŒ–è·ç¦»æ˜¾ç¤º
        function formatDistance(distance) {
            if (distance === 0) {
                return '';
            } else if (distance >= 1000) {
                return `${(distance / 1000).toFixed(1)}km`;
            } else {
                return `${distance}m`;
            }
        }

        // è·å–åœ°å›¾è¯­è¨€è®¾ç½®
        function getMapLanguage() {
            const language = GetUrlParam('language') || 'zh-CN';
            const region = GetUrlParam('region') || 'CN';
            return { language, region };
        }

        // è·å–UIæ–‡æœ¬
        function getUIText() {
            const { language } = getMapLanguage();
            const isChinese = language === 'zh-CN';

            return {
                searchPlaceholder: isChinese ? 'æœç´¢åœ°ç‚¹' : 'Search location',
                cancelButton: isChinese ? 'å–æ¶ˆ' : 'Cancel',

                closeButton: isChinese ? 'å…³é—­' : 'Close',
                doneButton: isChinese ? 'å®Œæˆ' : 'Done',
                myLocationButton: isChinese ? 'æˆ‘çš„ä½ç½®' : 'My Location',
                searchingText: isChinese ? 'æ­£åœ¨æœç´¢...' : 'Searching...',
                noResultsText: isChinese ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³åœ°ç‚¹' : 'No relevant results found',
                searchErrorText: isChinese ? 'æœç´¢æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•' : 'Search error, please try again',
                nearbySearchingText: isChinese ? 'æ­£åœ¨æœç´¢é™„è¿‘åœ°ç‚¹...' : 'Searching nearby places...',
                noNearbyText: isChinese ? 'é™„è¿‘200ç±³å†…æ²¡æœ‰æ‰¾åˆ°ç›¸å…³åœ°ç‚¹' : 'No nearby places found within 200m',
                nearbyErrorText: isChinese ? 'è·å–é™„è¿‘åœ°ç‚¹æ—¶å‘ç”Ÿé”™è¯¯' : 'Error getting nearby places',
                apiUnavailableText: isChinese ? 'Google Maps API ä¸å¯ç”¨' : 'Google Maps API not available',
                locationFailedText: isChinese ? 'è·å–ä½ç½®å¤±è´¥' : 'Failed to get location',
                browserNotSupportText: isChinese ? 'æµè§ˆå™¨ä¸æ”¯æŒä½ç½®æœåŠ¡' : 'Browser does not support location',
                selectLocationFirstText: isChinese ? 'è¯·å…ˆé€‰æ‹©ä½ç½®' : 'Please select a location first',

                mapLoadingFailedText: isChinese ? 'åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥' : 'Map loading failed, please check network connection',
                unknownLocationText: isChinese ? 'æœªçŸ¥åœ°ç‚¹' : 'Unknown Location',
                addressUnavailableText: isChinese ? 'åœ°å€ä¿¡æ¯ä¸å¯ç”¨' : 'Address information unavailable',
                coordinatesText: isChinese ? 'åæ ‡' : 'Coordinates'
            };
        }

        function loadGoogleMapsAPI() {
            return new Promise((resolve, reject) => {
                if (window.google && window.google.maps) {
                    resolve();
                    return;
                }

                mapKey = GetUrlParam('key') || 'AIzaSyCrTvmsON6OSpseuRlOJ_Cuc_KeQkjVmgs';
                const { language, region } = getMapLanguage();

                const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
                if (existingScript) {
                    existingScript.onload = () => resolve();
                    existingScript.onerror = reject;
                    return;
                }

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${mapKey}&libraries=places&v=beta&language=${language}&region=${region}&callback=initMapCallback`;
                script.async = true;
                script.defer = true;

                window.initMapCallback = () => {
                    setTimeout(resolve, 500);
                };

                const timeout = setTimeout(() => {
                    reject(new Error('API loading timeout'));
                }, 15000);

                script.onload = () => clearTimeout(timeout);
                script.onerror = (error) => {
                    clearTimeout(timeout);
                    reject(error);
                };

                document.head.appendChild(script);
            });
        }

        function removePostalCode(address) {
            if (!address) return address;

            let cleanedAddress = address;

            // ç§»é™¤ Plus Code æ ¼å¼ï¼ˆå¦‚ 5CP9+QMï¼‰
            cleanedAddress = cleanedAddress.replace(/[A-Z0-9]{4}\+[A-Z0-9]{2,}/g, '').trim();

            // ç§»é™¤é‚®æ”¿ç¼–ç ç›¸å…³æ–‡æœ¬ï¼ˆä¿ç•™é—¨ç‰Œå·ï¼‰
            cleanedAddress = cleanedAddress.replace(/é‚®æ”¿ç¼–ç :.*$/g, '').trim();
            cleanedAddress = cleanedAddress.replace(/é‚®ç¼–:.*$/g, '').trim();
            cleanedAddress = cleanedAddress.replace(/Postal Code:.*$/g, '').trim();
            cleanedAddress = cleanedAddress.replace(/Zip Code:.*$/g, '').trim();
            cleanedAddress = cleanedAddress.replace(/é‚®ç¼–.*$/g, '').trim();
            cleanedAddress = cleanedAddress.replace(/Postal.*$/g, '').trim();
            cleanedAddress = cleanedAddress.replace(/Zip.*$/g, '').trim();

            // ç§»é™¤ç‹¬ç«‹çš„6ä½æ•°å­—ï¼ˆä¸­å›½é‚®æ”¿ç¼–ç ï¼‰- åªç§»é™¤ç‹¬ç«‹çš„é‚®æ”¿ç¼–ç ï¼Œä¸ç§»é™¤é—¨ç‰Œå·
            cleanedAddress = cleanedAddress.replace(/\b\d{6}\b/g, '').trim();

            // ç§»é™¤ç‹¬ç«‹çš„5ä½æ•°å­—ï¼ˆç¾å›½é‚®æ”¿ç¼–ç ï¼‰- åªç§»é™¤ç‹¬ç«‹çš„é‚®æ”¿ç¼–ç 
            cleanedAddress = cleanedAddress.replace(/\b\d{5}(?:-\d{4})?\b/g, '').trim();

            // ç§»é™¤å…¶ä»–å›½å®¶çš„é‚®æ”¿ç¼–ç æ ¼å¼
            cleanedAddress = cleanedAddress.replace(/\b[A-Z]\d[A-Z]\s?\d[A-Z]\d\b/g, '').trim(); // åŠ æ‹¿å¤§æ ¼å¼
            cleanedAddress = cleanedAddress.replace(/\b\d{4}\s?[A-Z]{2}\b/g, '').trim(); // è·å…°æ ¼å¼
            cleanedAddress = cleanedAddress.replace(/\b\d{5}\b/g, '').trim(); // å…¶ä»–5ä½æ•°å­—

            // æ¸…ç†å¤šä½™çš„æ ‡ç‚¹ç¬¦å·å’Œç©ºæ ¼
            cleanedAddress = cleanedAddress.replace(/[,ï¼Œ\s:ï¼š]+$/, '').trim();
            cleanedAddress = cleanedAddress.replace(/^[,ï¼Œ\s:ï¼š]+/, '').trim();
            cleanedAddress = cleanedAddress.replace(/[,ï¼Œ\s:ï¼š]{2,}/g, ', ').trim();

            return cleanedAddress;
        }

        function reverseGeocode(lat, lng) {
            if (!geocoder) {
                geocoder = new google.maps.Geocoder();
            }

            const latlng = new google.maps.LatLng(lat, lng);
            const { language } = getMapLanguage();

            console.log('å¼€å§‹åå‘åœ°ç†ç¼–ç :', { lat, lng });

            geocoder.geocode({
                'location': latlng,
                'language': language
            }, (results, status) => {
                console.log('åå‘åœ°ç†ç¼–ç ç»“æœ:', { status, results });

                if (status === 'OK' && results[0]) {
                    const cleanedAddress = removePostalCode(results[0].formatted_address);
                    let specificName = '';

                    // å°è¯•ä»åœ°å€ç»„ä»¶ä¸­æå–æ›´å…·ä½“çš„åç§°
                    if (results[0].address_components) {
                        // ä¼˜å…ˆæŸ¥æ‰¾å»ºç­‘ç‰©ã€å…´è¶£ç‚¹ç­‰å…·ä½“åœ°ç‚¹
                        const buildingComponent = results[0].address_components.find(comp =>
                            comp.types.includes('establishment') ||
                            comp.types.includes('point_of_interest') ||
                            comp.types.includes('premise') ||
                            comp.types.includes('subpremise')
                        );

                        if (buildingComponent) {
                            specificName = buildingComponent.long_name;
                        } else {
                            // å¦‚æœæ²¡æœ‰å…·ä½“å»ºç­‘ç‰©ï¼Œå°è¯•ç»„åˆè¡—é“å·å’Œè¡—é“å
                            const streetNumber = results[0].address_components.find(comp =>
                                comp.types.includes('street_number')
                            );
                            const route = results[0].address_components.find(comp =>
                                comp.types.includes('route')
                            );

                            if (streetNumber && route) {
                                specificName = `${streetNumber.long_name}${route.long_name}`;
                            } else if (route) {
                                specificName = route.long_name;
                            } else {
                                // å¦‚æœéƒ½æ²¡æœ‰ï¼Œå°è¯•ä½¿ç”¨å­åŒºåŸŸåç§°
                                const sublocality = results[0].address_components.find(comp =>
                                    comp.types.includes('sublocality')
                                );
                                if (sublocality) {
                                    specificName = sublocality.long_name;
                                }
                            }
                        }
                    }

                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°å…·ä½“åç§°ï¼Œä½¿ç”¨æ¸…ç†åçš„åœ°å€
                    if (!specificName) {
                        specificName = cleanedAddress;
                    }

                    console.log('æ¸…ç†åçš„åœ°å€å’Œåç§°:', { cleanedAddress, specificName });

                    const obj = {
                        address: cleanedAddress,
                        lat: lat,
                        lng: lng,
                        name: specificName
                    };

                    console.log('åˆ›å»ºçš„ä½ç½®å¯¹è±¡:', obj);

                    updateMarker(lat, lng, obj);
                    selectedLocation = obj;

                    // å¯ç”¨ç¡®è®¤æŒ‰é’®
                    const confirmButton = document.getElementById('confirmButton');
                    if (confirmButton) {
                        confirmButton.disabled = false;
                    }
                } else {
                    console.error('åå‘åœ°ç†ç¼–ç å¤±è´¥:', status);
                    const uiText = getUIText();
                    // å½“åå‘åœ°ç†ç¼–ç å¤±è´¥æ—¶ï¼Œæ˜¾ç¤ºåæ ‡ä¿¡æ¯
                    const obj = {
                        address: `${uiText.coordinatesText}: ${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                        lat: lat,
                        lng: lng,
                        name: uiText.unknownLocationText
                    };
                    updateMarker(lat, lng, obj);
                    selectedLocation = obj;

                    // å¯ç”¨ç¡®è®¤æŒ‰é’®
                    const confirmButton = document.getElementById('confirmButton');
                    if (confirmButton) {
                        confirmButton.disabled = false;
                    }
                }
            });
        }

        function updateMarker(lat, lng, locationData) {
            const position = { lat: parseFloat(lat), lng: parseFloat(lng) };

            console.log('æ›´æ–°æ ‡è®°ä½ç½®:', position);
            console.log('ä½ç½®æ•°æ®:', locationData);

            if (marker) {
                // å¯¹äº AdvancedMarkerElementï¼Œä½¿ç”¨ position å±æ€§
                marker.position = position;
            }














        }

        function searchAddress() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const query = searchInput.value.trim();

            if (query.length === 0) {
                getLocationBasedSuggestions();
                return;
            }

            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }

            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            searchTimeout = setTimeout(() => {
                performSearch(query, searchResults);
            }, 200);
        }

        async function getSearchSuggestions(query) {
            if (!window.google || !window.google.maps || query.length < 2) {
                return;
            }

            try {
                const { Place } = await google.maps.importLibrary("places");
                const center = map.getCenter();

                const { language, region } = getMapLanguage();
                const request = {
                    textQuery: query,
                    fields: ['displayName', 'location', 'formattedAddress'],
                    locationBias: center,
                    language: language,
                    maxResultCount: 5,
                    region: region,
                };

                const { places } = await Place.searchByText(request);

                if (places.length > 0) {
                    displaySearchSuggestions(places);
                }
            } catch (error) {
                console.error('è·å–æœç´¢å»ºè®®å¤±è´¥:', error);
            }
        }

        function displaySearchSuggestions(places) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';

            // è·å–å½“å‰æ ‡è®°ä½ç½®æˆ–åœ°å›¾ä¸­å¿ƒä½œä¸ºå‚è€ƒç‚¹
            let centerLat, centerLng;
            if (marker && marker.position) {
                centerLat = marker.position.lat;
                centerLng = marker.position.lng;
            } else {
                const center = map.getCenter();
                centerLat = center.lat();
                centerLng = center.lng();
            }

            places.forEach(place => {
                const item = document.createElement('div');
                item.className = 'search-result-item';

                const name = place.displayName || '';
                const address = place.formattedAddress || '';

                // æ¸…ç†é‚®æ”¿ç¼–ç 
                const cleanName = removePostalCode(name);
                const cleanAddress = removePostalCode(address);

                // è®¡ç®—è·ç¦»
                let distance = '';
                if (place.location) {
                    let placeLat, placeLng;
                    if (typeof place.location.lat === 'function') {
                        placeLat = place.location.lat();
                        placeLng = place.location.lng();
                    } else if (typeof place.location.lat === 'number') {
                        placeLat = place.location.lat;
                        placeLng = place.location.lng;
                    }

                    if (placeLat && placeLng) {
                        distance = calculateDistance(centerLat, centerLng, placeLat, placeLng);
                    }
                }

                // åˆ›å»ºå†…å®¹å®¹å™¨
                const contentDiv = document.createElement('div');
                contentDiv.className = 'content';

                let displayContent = '';
                if (cleanName && cleanAddress && cleanName !== cleanAddress) {
                    const distanceText = formatDistance(distance);
                    const separator = distanceText ? ' | ' : '';
                    displayContent = `
            <div class="location-name">${cleanName}</div>
            <div class="location-address">${distanceText}${separator}${cleanAddress}</div>
          `;
                } else if (cleanName) {
                    const distanceText = formatDistance(distance);
                    if (distanceText) {
                        displayContent = `
              <div class="location-name">${cleanName}</div>
              <div class="location-address">${distanceText}</div>
            `;
                    } else {
                        displayContent = `<div class="location-name">${cleanName}</div>`;
                    }
                } else if (cleanAddress) {
                    const distanceText = formatDistance(distance);
                    if (distanceText) {
                        displayContent = `
              <div class="location-name">${cleanAddress}</div>
              <div class="location-address">${distanceText}</div>
            `;
                    } else {
                        displayContent = `<div class="location-name">${cleanAddress}</div>`;
                    }
                }

                contentDiv.innerHTML = displayContent;

                // åˆ›å»ºé€‰æ‹©æ¡†å®¹å™¨
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox';
                checkboxDiv.textContent = ''; // åˆå§‹ä¸ºç©º

                // å°†ä¸¤ä¸ªdivæ·»åŠ åˆ°itemä¸­
                item.appendChild(contentDiv);
                item.appendChild(checkboxDiv);

                item.onclick = () => {
                    // æ¸…é™¤æ‰€æœ‰å·²é€‰ä¸­çš„çŠ¶æ€
                    const allItems = searchResults.querySelectorAll('.search-result-item');
                    allItems.forEach(item => {
                        item.classList.remove('selected');
                        const checkbox = item.querySelector('.checkbox');
                        if (checkbox) checkbox.textContent = '';
                    });

                    // ä¸ºå½“å‰ç‚¹å‡»çš„itemæ·»åŠ é€‰ä¸­çŠ¶æ€
                    item.classList.add('selected');
                    checkboxDiv.textContent = 'âœ“';

                    selectSearchResultNew(place);
                };
                searchResults.appendChild(item);
            });

            searchResults.style.display = 'block';

            // å¦‚æœè¾“å…¥æ¡†æœ‰ç„¦ç‚¹ï¼Œæ€»æ˜¯æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
            const cancelButton = document.getElementById('cancelButton');
            const searchInput = document.getElementById('searchInput');
            if (cancelButton && searchInput) {
                if (searchInput === document.activeElement) {
                    // è¾“å…¥æ¡†æœ‰ç„¦ç‚¹æ—¶ï¼Œæ€»æ˜¯æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
                    cancelButton.style.display = 'inline-block';
                } else {
                    // è¾“å…¥æ¡†æ²¡æœ‰ç„¦ç‚¹æ—¶ï¼Œæ ¹æ®æœç´¢æ–‡æœ¬å†…å®¹å†³å®šæ˜¯å¦æ˜¾ç¤º
                    const query = searchInput.value.trim();
                    if (query.length > 0) {
                        cancelButton.style.display = 'inline-block';
                    } else {
                        cancelButton.style.display = 'none';
                    }
                }
            }
        }

        function handleSearchFocus() {
            const searchInput = document.getElementById('searchInput');
            const cancelButton = document.getElementById('cancelButton');
            const searchBox = document.querySelector('.search-box');
            const googleMap = document.getElementById('googleMap');
            const mapControls = document.querySelector('.map-controls');
            const query = searchInput.value.trim();

            // è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ï¼Œæ€»æ˜¯æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
            cancelButton.style.display = 'inline-block';

            // å±è”½è·å–ç„¦ç‚¹æ—¶çš„è‡ªåŠ¨æœç´¢ï¼Œåªæ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
            // if (query.length >= 2) {
            //   getSearchSuggestions(query);
            // } else if (query.length === 0) {
            //   getLocationBasedSuggestions();
            // }
        }

        function handleSearchBlur() {
            const cancelButton = document.getElementById('cancelButton');
            const searchInput = document.getElementById('searchInput');
            const searchBox = document.querySelector('.search-box');
            const googleMap = document.getElementById('googleMap');
            const mapControls = document.querySelector('.map-controls');
            const query = searchInput.value.trim();

            // æ ¹æ®æœç´¢æ–‡æœ¬å†…å®¹å†³å®šæ˜¯å¦æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
            if (query.length > 0) {
                cancelButton.style.display = 'inline-block';
            } else {
                cancelButton.style.display = 'none';
            }

            // ç§»é™¤åŠ¨æ€å¸ƒå±€æ¢å¤ï¼Œä¿æŒå›ºå®šå¸ƒå±€
        }

        function cancelSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const cancelButton = document.getElementById('cancelButton');

            // æ¸…ç©ºæœç´¢æ–‡æœ¬
            searchInput.value = '';
            // éšè—æœç´¢ç»“æœ
            searchResults.style.display = 'none';
            // éšè—å–æ¶ˆæŒ‰é’®
            cancelButton.style.display = 'none';
            // å¤±å»ç„¦ç‚¹
            searchInput.blur();

            // ç«‹å³è¿›è¡Œå®šä½æœç´¢
            getLocationBasedSuggestions();
        }

        async function performSearch(query, searchResults) {
            const uiText = getUIText();
            if (!window.google || !window.google.maps) {
                searchResults.innerHTML = `<div class="search-result-item" style="text-align: center; color: #666;">${uiText.apiUnavailableText}</div>`;
                return;
            }

            const cacheKey = query.toLowerCase().trim();
            if (searchCache.has(cacheKey)) {
                displaySearchResults(searchCache.get(cacheKey));
                return;
            }

            searchResults.innerHTML = '';
            searchResults.style.display = 'block';
            searchResults.innerHTML = `<div class="search-result-item" style="text-align: center; color: #666;">${uiText.searchingText}</div>`;

            try {
                // ä½¿ç”¨æ–°çš„ Places API è¿›è¡Œæ–‡æœ¬æœç´¢
                const { Place } = await google.maps.importLibrary("places");

                const { language, region } = getMapLanguage();
                const request = {
                    textQuery: query,
                    fields: ['displayName', 'location', 'businessStatus', 'formattedAddress', 'addressComponents'],
                    locationBias: map.getCenter(),
                    language: language,
                    maxResultCount: 15,
                    region: region,
                };

                console.log('å‘é€æ–‡æœ¬æœç´¢è¯·æ±‚:', request);

                const { places } = await Place.searchByText(request);

                console.log('æ–‡æœ¬æœç´¢ç»“æœæ•°é‡:', places.length);

                if (places.length > 0) {
                    // è½¬æ¢ä¸ºå…¼å®¹çš„æ ¼å¼
                    const validResults = places.filter(place => place.location).map(place => ({
                        name: place.displayName || '',
                        formatted_address: place.formattedAddress || '',
                        geometry: {
                            location: place.location
                        },
                        place_id: place.id || '',
                        types: place.primaryType ? [place.primaryType] : []
                    }));

                    searchCache.set(cacheKey, validResults);

                    if (searchCache.size > 50) {
                        const firstKey = searchCache.keys().next().value;
                        searchCache.delete(firstKey);
                    }

                    displaySearchResults(validResults);
                } else {
                    console.log('æ²¡æœ‰æ‰¾åˆ°æœç´¢ç»“æœ');
                    searchResults.innerHTML = `<div class="search-result-item" style="text-align: center; color: #666;">${uiText.noResultsText}</div>`;
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                searchResults.innerHTML = `<div class="search-result-item" style="text-align: center; color: #666;">${uiText.searchErrorText}</div>`;
            }
        }



        function displaySearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';

            // è·å–å½“å‰æ ‡è®°ä½ç½®æˆ–åœ°å›¾ä¸­å¿ƒä½œä¸ºå‚è€ƒç‚¹
            let centerLat, centerLng;
            if (marker && marker.position) {
                centerLat = marker.position.lat;
                centerLng = marker.position.lng;
            } else {
                const center = map.getCenter();
                centerLat = center.lat();
                centerLng = center.lng();
            }

            results.forEach(place => {
                const item = document.createElement('div');
                item.className = 'search-result-item';

                const name = place.name || '';
                const address = place.formatted_address || '';
                const types = place.types || [];

                const cleanName = removePostalCode(name);
                const cleanAddress = removePostalCode(address);

                // è®¡ç®—è·ç¦»
                let distance = '';
                if (place.geometry && place.geometry.location) {
                    let placeLat, placeLng;
                    if (typeof place.geometry.location.lat === 'function') {
                        placeLat = place.geometry.location.lat();
                        placeLng = place.geometry.location.lng();
                    } else if (typeof place.geometry.location.lat === 'number') {
                        placeLat = place.geometry.location.lat;
                        placeLng = place.geometry.location.lng;
                    }

                    if (placeLat && placeLng) {
                        distance = calculateDistance(centerLat, centerLng, placeLat, placeLng);
                    }
                }

                // åˆ›å»ºå†…å®¹å®¹å™¨
                const contentDiv = document.createElement('div');
                contentDiv.className = 'content';

                let displayContent = '';
                if (cleanName && cleanAddress && cleanName !== cleanAddress) {
                    const distanceText = formatDistance(distance);
                    const separator = distanceText ? ' | ' : '';
                    displayContent = `
            <div class="location-name">${cleanName}</div>
            <div class="location-address">${distanceText}${separator}${cleanAddress}</div>
          `;
                } else if (cleanName) {
                    const distanceText = formatDistance(distance);
                    if (distanceText) {
                        displayContent = `
              <div class="location-name">${cleanName}</div>
              <div class="location-address">${distanceText}</div>
            `;
                    } else {
                        displayContent = `<div class="location-name">${cleanName}</div>`;
                    }
                } else if (cleanAddress) {
                    const distanceText = formatDistance(distance);
                    if (distanceText) {
                        displayContent = `
              <div class="location-name">${cleanAddress}</div>
              <div class="location-address">${distanceText}</div>
            `;
                    } else {
                        displayContent = `<div class="location-name">${cleanAddress}</div>`;
                    }
                }

                contentDiv.innerHTML = displayContent;

                // åˆ›å»ºé€‰æ‹©æ¡†å®¹å™¨
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox';
                checkboxDiv.textContent = ''; // åˆå§‹ä¸ºç©º

                // å°†ä¸¤ä¸ªdivæ·»åŠ åˆ°itemä¸­
                item.appendChild(contentDiv);
                item.appendChild(checkboxDiv);

                item.onclick = () => {
                    // æ¸…é™¤æ‰€æœ‰å·²é€‰ä¸­çš„çŠ¶æ€
                    const allItems = searchResults.querySelectorAll('.search-result-item');
                    allItems.forEach(item => {
                        item.classList.remove('selected');
                        const checkbox = item.querySelector('.checkbox');
                        if (checkbox) checkbox.textContent = '';
                    });

                    // ä¸ºå½“å‰ç‚¹å‡»çš„itemæ·»åŠ é€‰ä¸­çŠ¶æ€
                    item.classList.add('selected');
                    checkboxDiv.textContent = 'âœ“';

                    selectSearchResult(place);
                };
                searchResults.appendChild(item);
            });

            searchResults.style.display = 'block';

            // å¦‚æœè¾“å…¥æ¡†æœ‰ç„¦ç‚¹ï¼Œæ€»æ˜¯æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
            const cancelButton = document.getElementById('cancelButton');
            const searchInput = document.getElementById('searchInput');
            if (cancelButton && searchInput) {
                if (searchInput === document.activeElement) {
                    // è¾“å…¥æ¡†æœ‰ç„¦ç‚¹æ—¶ï¼Œæ€»æ˜¯æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
                    cancelButton.style.display = 'inline-block';
                } else {
                    // è¾“å…¥æ¡†æ²¡æœ‰ç„¦ç‚¹æ—¶ï¼Œæ ¹æ®æœç´¢æ–‡æœ¬å†…å®¹å†³å®šæ˜¯å¦æ˜¾ç¤º
                    const query = searchInput.value.trim();
                    if (query.length > 0) {
                        cancelButton.style.display = 'inline-block';
                    } else {
                        cancelButton.style.display = 'none';
                    }
                }
            }
        }

        function selectSearchResultNew(place) {
            if (!place.location) {
                console.error('æœç´¢ç»“æœç¼ºå°‘ä½ç½®ä¿¡æ¯:', place);
                return;
            }

            console.log('é€‰æ‹©åœ°ç‚¹:', place);

            // å¤„ç†æ–°ç‰ˆæœ¬APIçš„LatLngå¯¹è±¡
            let placeLat, placeLng;
            if (place.location && typeof place.location.lat === 'function') {
                // å¦‚æœæ˜¯LatLngå¯¹è±¡ï¼Œä½¿ç”¨.lat()å’Œ.lng()æ–¹æ³•
                placeLat = place.location.lat();
                placeLng = place.location.lng();
            } else if (place.location && typeof place.location.lat === 'number') {
                // å¦‚æœæ˜¯æ™®é€šå¯¹è±¡ï¼Œç›´æ¥è®¿é—®latå’Œlngå±æ€§
                placeLat = place.location.lat;
                placeLng = place.location.lng;
            } else {
                console.error('æ— æ³•è·å–åœ°ç‚¹åæ ‡:', place.location);
                return;
            }

            // ç¡®ä¿åæ ‡æ˜¯æœ‰æ•ˆçš„æ•°å­—
            if (isNaN(placeLat) || isNaN(placeLng)) {
                console.error('åœ°ç‚¹åæ ‡æ— æ•ˆ:', { lat: placeLat, lng: placeLng });
                return;
            }

            const position = { lat: placeLat, lng: placeLng };

            // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
            map.setCenter(position);

            // è®¾ç½®æ ‡è®°ä½ç½®
            if (marker) {
                marker.position = position;
            }

            // è·å–é€‰ä¸­çš„æœç´¢ç»“æœé¡¹çš„æ˜¾ç¤ºåç§°
            const selectedItem = document.querySelector('.search-result-item.selected');
            let selectedItemName = '';
            if (selectedItem) {
                const nameElement = selectedItem.querySelector('.location-name');
                if (nameElement) {
                    selectedItemName = nameElement.textContent.trim();
                }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°é€‰ä¸­çš„itemåç§°ï¼Œåˆ™ä½¿ç”¨placeçš„displayNameä½œä¸ºå¤‡é€‰
            const name = selectedItemName || place.displayName || '';
            const locationData = {
                address: removePostalCode(place.formattedAddress || ''),
                name: removePostalCode(name),
                lat: placeLat,
                lng: placeLng
            };

            // ç›´æ¥è®¾ç½®æ ‡è®°ä½ç½®ï¼Œä¸è°ƒç”¨updateMarkeré¿å…è§¦å‘åå‘åœ°ç†ç¼–ç 
            if (marker) {
                marker.position = position;
            }
            selectedLocation = locationData;

            // å¯ç”¨ç¡®è®¤æŒ‰é’®
            const confirmButton = document.getElementById('confirmButton');
            if (confirmButton) {
                confirmButton.disabled = false;
            }

            console.log('åœ°å›¾å·²å®šä½åˆ°:', position);
            console.log('é€‰ä¸­çš„æœç´¢ç»“æœé¡¹åç§°:', selectedItemName);
        }

        function selectSearchResult(place) {
            if (!place.geometry || !place.geometry.location) {
                console.error('æœç´¢ç»“æœç¼ºå°‘ä½ç½®ä¿¡æ¯:', place);
                return;
            }

            console.log('é€‰æ‹©æœç´¢ç»“æœ:', place);

            const position = place.geometry.location;
            let lat, lng;

            // å¤„ç†ä¸åŒæ ¼å¼çš„ä½ç½®å¯¹è±¡
            if (typeof position.lat === 'function') {
                lat = position.lat();
                lng = position.lng();
            } else if (typeof position.lat === 'number') {
                lat = position.lat;
                lng = position.lng;
            } else {
                console.error('æ— æ³•è·å–ä½ç½®åæ ‡:', position);
                return;
            }

            // ç¡®ä¿åæ ‡æ˜¯æœ‰æ•ˆçš„æ•°å­—
            if (isNaN(lat) || isNaN(lng)) {
                console.error('æ— æ•ˆçš„åæ ‡:', { lat, lng });
                return;
            }

            const mapPosition = { lat: parseFloat(lat), lng: parseFloat(lng) };

            console.log('è®¾ç½®åœ°å›¾ä½ç½®:', mapPosition);

            // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
            map.setCenter(mapPosition);

            // è®¾ç½®æ ‡è®°ä½ç½®
            if (marker) {
                marker.position = mapPosition;
            }



            const locationData = {
                address: removePostalCode(place.formatted_address),
                name: removePostalCode(place.name || place.formatted_address),
                lat: lat,
                lng: lng
            };

            // ç›´æ¥è®¾ç½®æ ‡è®°ä½ç½®ï¼Œä¸è°ƒç”¨updateMarkeré¿å…è§¦å‘åå‘åœ°ç†ç¼–ç 
            if (marker) {
                marker.position = mapPosition;
            }
            selectedLocation = locationData;

            // å¯ç”¨ç¡®è®¤æŒ‰é’®
            const confirmButton = document.getElementById('confirmButton');
            if (confirmButton) {
                confirmButton.disabled = false;
            }

            console.log('åœ°å›¾å·²å®šä½åˆ°:', mapPosition);


        }

        async function getLocationBasedSuggestions() {
            const searchResults = document.getElementById('searchResults');

            // ä¼˜å…ˆä½¿ç”¨æ ‡è®°ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰æ ‡è®°åˆ™ä½¿ç”¨åœ°å›¾ä¸­å¿ƒ
            let center;
            if (marker && marker.position) {
                center = marker.position;
            } else {
                center = map.getCenter();
            }

            if (!center) {
                console.log('æ— æ³•è·å–ä½ç½®ä¿¡æ¯');
                return;
            }

            const uiText = getUIText();
            if (!window.google || !window.google.maps) {
                searchResults.innerHTML = `<div class="search-result-item" style="text-align: center; color: #666;">${uiText.apiUnavailableText}</div>`;
                searchResults.style.display = 'block';
                return;
            }

            searchResults.innerHTML = `<div class="search-result-item" style="text-align: center; color: #666;">${uiText.nearbySearchingText}</div>`;
            searchResults.style.display = 'block';

            try {
                // ä½¿ç”¨æ–°çš„ Places API
                const { Place, SearchNearbyRankPreference } = await google.maps.importLibrary('places');

                const { language } = getMapLanguage();
                const request = {
                    // å¿…éœ€å‚æ•°
                    fields: ['displayName', 'location', 'businessStatus', 'addressComponents', 'formattedAddress'],
                    locationRestriction: {
                        center: center,
                        radius: 200, // 200ç±³èŒƒå›´
                    },
                    // å¯é€‰å‚æ•° - ç§»é™¤ç±»å‹é™åˆ¶ï¼Œè®©æœç´¢æ›´å¹¿æ³›
                    maxResultCount: 20,
                    rankPreference: SearchNearbyRankPreference.DISTANCE, // æŒ‰è·ç¦»æ’åº
                    language: language,
                };



                const { places } = await Place.searchNearby(request);



                if (places.length > 0) {

                    displayLocationBasedSuggestions(places);
                } else {


                    // å¦‚æœ200ç±³å†…æ²¡æœ‰ç»“æœï¼Œå°è¯•500ç±³
                    const request500 = {
                        fields: ['displayName', 'location', 'businessStatus', 'addressComponents', 'formattedAddress'],
                        locationRestriction: {
                            center: center,
                            radius: 500,
                        },
                        // ç§»é™¤ç±»å‹é™åˆ¶ï¼Œè®©æœç´¢æ›´å¹¿æ³›
                        maxResultCount: 20,
                        rankPreference: SearchNearbyRankPreference.DISTANCE,
                        language: language,
                    };

                    const { places: places500 } = await Place.searchNearby(request500);



                    if (places500.length > 0) {

                        displayLocationBasedSuggestions(places500);
                    } else {

                        searchResults.innerHTML = `<div class="search-result-item" style="text-align: center; color: #666;">${uiText.noNearbyText}</div>`;
                    }
                }
            } catch (error) {
                console.error('è·å–åŸºäºä½ç½®çš„æœç´¢å»ºè®®å¤±è´¥:', error);
                searchResults.innerHTML = `<div class="search-result-item" style="text-align: center; color: #666;">${uiText.nearbyErrorText}</div>`;
            }
        }

        function displayLocationBasedSuggestions(places) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';

            // è®¡ç®—æ¯ä¸ªåœ°ç‚¹åˆ°æ ‡è®°ä½ç½®çš„è·ç¦»
            let centerLat, centerLng;
            if (marker && marker.position) {
                centerLat = marker.position.lat;
                centerLng = marker.position.lng;
                console.log('ä½¿ç”¨æ ‡è®°ä½ç½®è®¡ç®—è·ç¦»:', { centerLat, centerLng });
            } else {
                const center = map.getCenter();
                centerLat = center.lat();
                centerLng = center.lng();
            }

            // è®¡ç®—è·ç¦»å¹¶æ’åº
            const placesWithDistance = places.map(place => {
                const name = place.displayName || '';
                const address = place.formattedAddress || '';

                // æ¸…ç†é‚®æ”¿ç¼–ç 
                const cleanName = removePostalCode(name);
                const cleanAddress = removePostalCode(address);

                // å¤„ç†æ–°ç‰ˆæœ¬APIçš„LatLngå¯¹è±¡
                let placeLat, placeLng;
                if (place.location && typeof place.location.lat === 'function') {
                    placeLat = place.location.lat();
                    placeLng = place.location.lng();
                } else if (place.location && typeof place.location.lat === 'number') {
                    placeLat = place.location.lat;
                    placeLng = place.location.lng;
                } else {
                    console.error('æ— æ³•è·å–åœ°ç‚¹åæ ‡:', place.location);
                    return null;
                }

                // ç¡®ä¿åæ ‡æ˜¯æœ‰æ•ˆçš„æ•°å­—
                if (isNaN(placeLat) || isNaN(placeLng)) {
                    console.error('åœ°ç‚¹åæ ‡æ— æ•ˆ:', { lat: placeLat, lng: placeLng });
                    return null;
                }

                const distance = calculateDistance(centerLat, centerLng, placeLat, placeLng);

                return {
                    place,
                    cleanName,
                    cleanAddress,
                    placeLat,
                    placeLng,
                    distance
                };
            }).filter(item => item !== null);

            // æŒ‰è·ç¦»æ’åºï¼ˆä»è¿‘åˆ°è¿œï¼‰
            placesWithDistance.sort((a, b) => a.distance - b.distance);

            placesWithDistance.forEach((item, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';

                const { place, cleanName, cleanAddress, distance } = item;

                // åˆ›å»ºå†…å®¹å®¹å™¨
                const contentDiv = document.createElement('div');
                contentDiv.className = 'content';

                let displayContent = '';

                // é»˜è®¤ç¬¬ä¸€æ¡ä¸ºé€‰ä¸­çŠ¶æ€ï¼Œæˆ–è€…å¦‚æœæœ‰å·²é€‰ä¸­çš„itemåˆ™æ˜¾ç¤ºå·²é€‰ä¸­çš„
                let isSelected = false;
                if (index === 0) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰å·²é€‰ä¸­çš„item
                    const selectedItems = searchResults.querySelectorAll('.checkbox');
                    if (selectedItems.length === 0 || Array.from(selectedItems).every(checkbox => !checkbox.textContent)) {
                        // æ²¡æœ‰é€‰ä¸­çš„itemï¼Œé»˜è®¤ç¬¬ä¸€æ¡ä¸ºé€‰ä¸­çŠ¶æ€
                        isSelected = true;
                    }
                }

                if (cleanName && cleanAddress && cleanName !== cleanAddress) {
                    const distanceText = formatDistance(distance);
                    const separator = distanceText ? ' | ' : '';
                    displayContent = `
            <div class="location-name">${cleanName}</div>
            <div class="location-address">${distanceText}${separator}${cleanAddress}</div>
          `;
                } else if (cleanName) {
                    displayContent = `
            <div class="location-name">${cleanName}</div>
            <div class="location-address">${formatDistance(distance)}</div>
          `;
                } else if (cleanAddress) {
                    displayContent = `
            <div class="location-name">${cleanAddress}</div>
            <div class="location-address">${formatDistance(distance)}</div>
          `;
                }

                contentDiv.innerHTML = displayContent;

                // åˆ›å»ºé€‰æ‹©æ¡†å®¹å™¨
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox';
                checkboxDiv.textContent = isSelected ? 'âœ“' : ''; // æ ¹æ®é€‰ä¸­çŠ¶æ€è®¾ç½®

                // å°†ä¸¤ä¸ªdivæ·»åŠ åˆ°itemä¸­
                resultItem.appendChild(contentDiv);
                resultItem.appendChild(checkboxDiv);

                // å¦‚æœé»˜è®¤é€‰ä¸­ï¼Œæ·»åŠ selectedç±»
                if (isSelected) {
                    resultItem.classList.add('selected');
                }

                // æ‰€æœ‰ç»“æœéƒ½å¯ä»¥ç‚¹å‡»
                resultItem.onclick = () => {
                    // æ¸…é™¤æ‰€æœ‰å·²é€‰ä¸­çš„çŠ¶æ€
                    const allItems = searchResults.querySelectorAll('.search-result-item');
                    allItems.forEach(item => {
                        item.classList.remove('selected');
                        const checkbox = item.querySelector('.checkbox');
                        if (checkbox) checkbox.textContent = '';
                    });

                    // ä¸ºå½“å‰ç‚¹å‡»çš„itemæ·»åŠ é€‰ä¸­çŠ¶æ€
                    resultItem.classList.add('selected');
                    checkboxDiv.textContent = 'âœ“';

                    selectSearchResultNew(place);
                };
                resultItem.style.cursor = 'pointer';
                resultItem.style.opacity = '1';

                searchResults.appendChild(resultItem);
            });

            searchResults.style.display = 'block';

            // å¦‚æœè¾“å…¥æ¡†æœ‰ç„¦ç‚¹ï¼Œæ€»æ˜¯æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
            const cancelButton = document.getElementById('cancelButton');
            const searchInput = document.getElementById('searchInput');
            if (cancelButton && searchInput) {
                if (searchInput === document.activeElement) {
                    // è¾“å…¥æ¡†æœ‰ç„¦ç‚¹æ—¶ï¼Œæ€»æ˜¯æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
                    cancelButton.style.display = 'inline-block';
                } else {
                    // è¾“å…¥æ¡†æ²¡æœ‰ç„¦ç‚¹æ—¶ï¼Œæ ¹æ®æœç´¢æ–‡æœ¬å†…å®¹å†³å®šæ˜¯å¦æ˜¾ç¤º
                    const query = searchInput.value.trim();
                    if (query.length > 0) {
                        cancelButton.style.display = 'inline-block';
                    } else {
                        cancelButton.style.display = 'none';
                    }
                }
            }
        }

        function confirmLocation() {
            if (selectedLocation) {
                if (window.uni) {
                    // è·å–é€‰ä¸­çš„æœç´¢ç»“æœé¡¹çš„æ˜¾ç¤ºåç§°
                    const selectedItem = document.querySelector('.search-result-item.selected');
                    let selectedItemName = selectedLocation.name; // é»˜è®¤ä½¿ç”¨selectedLocation.name

                    if (selectedItem) {
                        const nameElement = selectedItem.querySelector('.location-name');
                        if (nameElement) {
                            selectedItemName = nameElement.textContent.trim();
                        }
                    }

                    const locationData = {
                        type: 'locationSelected',
                        location: {
                            address: selectedItemName,
                            name: selectedItemName,
                            lat: selectedLocation.lat,
                            lng: selectedLocation.lng
                        }
                    };

                    console.log('å›å†™ä½ç½®æ•°æ®:', locationData);
                    console.log('ä½¿ç”¨çš„åç§°:', selectedItemName);

                    uni.postMessage({
                        data: locationData
                    });
                } else {
                    closeMap();
                }
            } else {
                const uiText = getUIText();
                if (window.uni) {
                    uni.showToast({
                        title: uiText.selectLocationFirstText,
                        icon: 'none'
                    });
                }
            }
        }

        function getMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        map.setCenter(pos);
                        if (marker) {
                            marker.position = pos;
                        }
                        reverseGeocode(pos.lat, pos.lng);

                        setTimeout(() => {
                            getLocationBasedSuggestions();
                        }, 1000);
                    },
                    (error) => {
                        console.error('è·å–ä½ç½®å¤±è´¥:', error);
                        const uiText = getUIText();
                        if (window.uni) {
                            uni.showToast({
                                title: uiText.locationFailedText,
                                icon: 'none'
                            });
                        }
                    }
                );
            } else {
                const uiText = getUIText();
                if (window.uni) {
                    uni.showToast({
                        title: uiText.browserNotSupportText,
                        icon: 'none'
                    });
                }
            }
        }



        async function initializeMap() {
            try {
                await loadGoogleMapsAPI();

                if (!window.google || !window.google.maps) {
                    throw new Error('Google Maps API æœªæ­£ç¡®åŠ è½½');
                }

                const latParam = GetUrlParam('lat');
                const lngParam = GetUrlParam('lng');

                let defaultLat, defaultLng;

                if (!latParam || !lngParam || latParam === '' || lngParam === '') {
                    defaultLat = 34.774124;
                    defaultLng = 113.807818;
                } else {
                    defaultLat = parseFloat(latParam);
                    defaultLng = parseFloat(lngParam);

                    if (isNaN(defaultLat) || isNaN(defaultLng)) {
                        defaultLat = 34.774124;
                        defaultLng = 113.807818;
                    }
                }

                // ä½¿ç”¨æ–°çš„ Maps API
                const { Map } = await google.maps.importLibrary('maps');

                const mapOptions = {
                    zoom: 15,
                    center: { lat: defaultLat, lng: defaultLng },
                    mapId: "DEMO_MAP_ID",
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                    zoomControl: false,
                    scaleControl: false,
                    rotateControl: false,
                    tilt: 0,
                    gestureHandling: 'greedy',
                    disableDefaultUI: true,
                    clickableIcons: false,
                    styles: [
                        {
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [{ visibility: "off" }]
                        }
                    ]
                };

                map = new Map(document.getElementById("googleMap"), mapOptions);

                // ä½¿ç”¨æ–°çš„ Marker API
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

                marker = new AdvancedMarkerElement({
                    position: { lat: defaultLat, lng: defaultLng },
                    map: map,
                    title: "Selected Location",
                    gmpDraggable: true, // å¯ç”¨æ‹–æ‹½
                });



                geocoder = new google.maps.Geocoder();

                reverseGeocode(defaultLat, defaultLng);

                setTimeout(() => {
                    getLocationBasedSuggestions();
                }, 1000);

                // åœ°å›¾ç‚¹å‡»äº‹ä»¶
                map.addListener('click', function (e) {
                    let lat, lng;

                    if (e.latLng && typeof e.latLng.lat === 'function') {
                        lat = e.latLng.lat();
                        lng = e.latLng.lng();
                    } else if (e.latLng && typeof e.latLng.lat === 'number') {
                        lat = e.latLng.lat;
                        lng = e.latLng.lng;
                    } else {
                        console.error('æ— æ³•ä»ç‚¹å‡»äº‹ä»¶è·å–æœ‰æ•ˆåæ ‡:', e.latLng);
                        return;
                    }

                    // ç¡®ä¿åæ ‡æ˜¯æœ‰æ•ˆçš„æ•°å­—
                    if (isNaN(lat) || isNaN(lng)) {
                        console.error('ç‚¹å‡»äº‹ä»¶è¿”å›æ— æ•ˆåæ ‡:', { lat, lng });
                        return;
                    }

                    console.log('åœ°å›¾ç‚¹å‡»ä½ç½®:', { lat, lng });

                    // å°†æ ‡è®°ç§»åŠ¨åˆ°ç‚¹å‡»ä½ç½®
                    if (marker) {
                        marker.position = { lat: lat, lng: lng };
                    }

                    // åå‘åœ°ç†ç¼–ç è·å–åœ°å€ä¿¡æ¯
                    reverseGeocode(lat, lng);

                    // åœ°å›¾ç‚¹å‡»åé‡æ–°æœç´¢é™„è¿‘åœ°ç‚¹
                    setTimeout(() => {
                        getLocationBasedSuggestions();
                    }, 500);
                });

                // æ ‡è®°æ‹–æ‹½ç»“æŸäº‹ä»¶
                marker.addListener('dragend', function (e) {
                    // ç›´æ¥ä»æ ‡è®°ä½ç½®è·å–åæ ‡ï¼Œè€Œä¸æ˜¯ä»äº‹ä»¶å¯¹è±¡
                    const position = marker.position;
                    const lat = position.lat;
                    const lng = position.lng;
                    console.log('æ ‡è®°æ‹–æ‹½åˆ°æ–°ä½ç½®:', { lat, lng });
                    reverseGeocode(lat, lng);

                    // æ ‡è®°æ‹–æ‹½åé‡æ–°æœç´¢é™„è¿‘åœ°ç‚¹
                    setTimeout(() => {
                        getLocationBasedSuggestions();
                    }, 500);
                });





            } catch (error) {
                console.error('åˆå§‹åŒ–åœ°å›¾å¤±è´¥:', error);
                const uiText = getUIText();
                document.getElementById("googleMap").innerHTML = `<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #666;">${uiText.mapLoadingFailedText}</div>`;
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            });
                        },
                        (error) => {
                            reject(error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                } else {
                    reject(new Error('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®'));
                }
            });
        }

        function closeMap() {
            if (window.uni) {
                uni.postMessage({
                    data: {
                        type: 'close',
                        message: 'User closed map'
                    }
                });
            } else {
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    window.close();
                }
            }
        }

        // åˆå§‹åŒ–UIæ–‡æœ¬
        function initializeUIText() {
            const uiText = getUIText();

            // æ›´æ–°æœç´¢æ¡†å ä½ç¬¦
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.placeholder = uiText.searchPlaceholder;
            }

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const cancelButton = document.getElementById('cancelButton');
            if (cancelButton) {
                cancelButton.textContent = uiText.cancelButton;
                // ç¡®ä¿å–æ¶ˆæŒ‰é’®åˆå§‹çŠ¶æ€ä¸ºéšè—
                cancelButton.style.display = 'none';
            }

            const doneButton = document.getElementById('confirmButton');
            if (doneButton) {
                doneButton.textContent = uiText.doneButton;
            }



            // æ›´æ–°æŒ‰é’®æ ‡é¢˜
            const closeBtn = document.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.title = uiText.closeButton;
            }

            const myLocationBtn = document.querySelector('.my-location-btn');
            if (myLocationBtn) {
                myLocationBtn.title = uiText.myLocationButton;
            }
        }

        window.addEventListener('load', async () => {
            // åˆå§‹åŒ–UIæ–‡æœ¬
            initializeUIText();

            try {
                // æ€»æ˜¯ä¼˜å…ˆè·å–ç”¨æˆ·å½“å‰ä½ç½®ï¼Œä¸ä½¿ç”¨URLä¸­çš„å†å²åæ ‡
                const currentPos = await getCurrentPosition();

                // æ›´æ–°URLå‚æ•°ä¸ºç”¨æˆ·å½“å‰ä½ç½®
                const url = new URL(window.location.href);
                url.searchParams.set('lat', currentPos.lat);
                url.searchParams.set('lng', currentPos.lng);
                window.history.replaceState({}, '', url);

                await initializeMap();
            } catch (error) {
                console.log('è·å–ç”¨æˆ·ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®:', error);
                // å¦‚æœè·å–ç”¨æˆ·ä½ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
                await initializeMap();
            }

            // æ·»åŠ æœç´¢è¾“å…¥äº‹ä»¶ç›‘å¬å™¨ï¼Œå®æ—¶æ§åˆ¶å–æ¶ˆæŒ‰é’®æ˜¾ç¤º
            const searchInput = document.getElementById('searchInput');
            const cancelButton = document.getElementById('cancelButton');

            if (searchInput && cancelButton) {
                searchInput.addEventListener('input', () => {
                    const query = searchInput.value.trim();
                    if (query.length > 0) {
                        cancelButton.style.display = 'inline-block';
                    } else {
                        cancelButton.style.display = 'none';
                    }
                });
            }

            document.addEventListener('click', (event) => {
                const searchBox = document.querySelector('.search-box');
                const searchResults = document.getElementById('searchResults');

                // åªæœ‰å½“æœç´¢ç»“æœä¸­æ²¡æœ‰å·²é€‰æ‹©çš„é¡¹ç›®æ—¶ï¼Œæ‰å…è®¸éšè—æœç´¢ç»“æœ
                if (searchBox && searchResults && !searchBox.contains(event.target)) {
                    const selectedItems = searchResults.querySelectorAll('.search-result-item.selected');
                    if (selectedItems.length === 0) {
                        searchResults.style.display = 'none';
                    }
                }
            });
        });

        window.googleMapSelectAPI = {
            setLocation: function (lat, lng) {
                if (map && marker) {
                    const position = { lat: parseFloat(lat), lng: parseFloat(lng) };
                    map.setCenter(position);
                    marker.position = position;
                    reverseGeocode(lat, lng);
                }
            },
            searchLocation: async function (query) {
                if (map && window.google && window.google.maps) {
                    try {
                        const { Place } = await google.maps.importLibrary("places");

                        const { language, region } = getMapLanguage();
                        const request = {
                            textQuery: query,
                            fields: ['displayName', 'location'],
                            language: language,
                            maxResultCount: 1,
                            region: region,
                        };

                        const { places } = await Place.searchByText(request);

                        if (places.length > 0) {
                            const place = places[0];
                            let lat, lng;

                            if (place.location && typeof place.location.lat === 'function') {
                                lat = place.location.lat();
                                lng = place.location.lng();
                            } else if (place.location && typeof place.location.lat === 'number') {
                                lat = place.location.lat;
                                lng = place.location.lng;
                            }

                            if (!isNaN(lat) && !isNaN(lng)) {
                                this.setLocation(lat, lng);
                            } else {
                                console.error('æœç´¢ç»“æœåŒ…å«æ— æ•ˆåæ ‡:', { lat, lng });
                            }
                        }
                    } catch (error) {
                        console.error('æœç´¢ä½ç½®å¤±è´¥:', error);
                    }
                }
            },
            close: closeMap,
            confirmLocation: confirmLocation,
            getMyLocation: getMyLocation
        };

        window.closeMap = closeMap;
    </script>
</body>

</html>